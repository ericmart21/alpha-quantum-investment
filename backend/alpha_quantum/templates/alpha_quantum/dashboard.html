{% extends "alpha_quantum/layout.html" %}
{% load static %}

{% block title %}Dashboard • Alpha Quantum{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  /* === Paleta y tokens === */
  :root {
    --bg:#0f1317; --panel:#151a21; --panel-2:#10161d; --border:#232a33;
    --text:#e7eef7; --muted:#9fb1c1;
    --accent:#19e3b1; --accent-2:#4ea8ff; --accent-3:#ff9f43; --danger:#ff5964;
  }
  body{ background:var(--bg); color:var(--text); }

  /* === Tarjeta base === */
  .card{ background:var(--panel)!important; border:1px solid var(--border)!important; border-radius:16px; box-shadow:0 4px 16px rgba(0,0,0,.25); }
  .card-header{ background:var(--panel-2)!important; color:var(--text)!important; border-bottom:1px solid var(--border)!important; border-top-left-radius:16px; border-top-right-radius:16px; }
  .table thead th{ color:var(--text); border-color:var(--border)!important; }
  .table tbody td{ color:var(--text); border-color:#1f2937!important; }
  .list-group-item{ background:#111827; color:var(--text); border-color:#1f2937; }
  .btn-outline-light{ --bs-btn-color:#e5e7eb; --bs-btn-border-color:#6b7280 }
  .form-control,.form-select{ background:#0f172a; color:#e5e7eb; border-color:#374151 }

  /* === KPI con icono === */
  .kpi{ display:flex; gap:14px; align-items:center; padding:18px; border-radius:16px;
        background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--panel);
        border:1px solid var(--border); }
  .kpi .kpi-icon{ width:48px; height:48px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.35rem; flex:0 0 48px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06); }
  .kpi .kpi-meta{ color:var(--muted); font-size:.9rem; margin-top:2px; }
  .kpi .kpi-value{ font-weight:800; font-size:1.8rem; letter-spacing:.3px; line-height:1.1; }
  .kpi.success .kpi-icon{ background:rgba(25,227,177,.12); color:var(--accent); border:1px solid rgba(25,227,177,.35); }
  .kpi.info    .kpi-icon{ background:rgba(78,168,255,.12); color:var(--accent-2); border:1px solid rgba(78,168,255,.35); }
  .kpi.warn    .kpi-icon{ background:rgba(255,159,67,.12); color:var(--accent-3); border:1px solid rgba(255,159,67,.35); }

  /* === Badges suaves === */
  .badge-soft{ border:1px solid var(--border); background:#0f161a; color:#cfe7df; padding:.25rem .5rem; border-radius:10px; font-size:.75rem; }
  .badge-profit{ color:var(--accent); border-color:rgba(25,227,177,.35); }
  .badge-loss  { color:var(--danger); border-color:rgba(255,89,100,.35); }

  /* Iconos de tipo transacción */
  .icon-buy{ color:var(--accent); font-size:1rem; }
  .icon-sell{ color:var(--danger); font-size:1rem; }

  .page-title{ font-weight:800; letter-spacing:.3px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="text-center mb-4">
    <h2 class="page-title">Dashboard de Rendimiento</h2>
  </div>

  {% if user.is_authenticated %}
  <!-- KPIs -->
  <div class="row g-4">
    <div class="col-md-4">
      <div class="kpi success">
        <div class="kpi-icon"><i class="bi bi-wallet2"></i></div>
        <div>
          <div class="text-secondary small">Valor Total</div>
          <div class="kpi-value">{{ valor_total_cartera|default:0|floatformat:2 }} €</div>
          <div class="kpi-meta">Valor actual de tu cartera</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="kpi info">
        <div class="kpi-icon"><i class="bi bi-cart-check"></i></div>
        <div>
          <div class="text-secondary small">Total Invertido</div>
          <div class="kpi-value">{{ total_invertido|default:0|floatformat:2 }} €</div>
          <div class="kpi-meta">Capital invertido en todas las operaciones</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="kpi {% if rentabilidad_total >= 0 %}success{% else %}warn{% endif %}">
        <div class="kpi-icon"><i class="bi bi-graph-up-arrow"></i></div>
        <div>
          <div class="text-secondary small">Rentabilidad</div>
          <div class="kpi-value d-flex align-items-center gap-2">
            {{ rentabilidad_total|default:0|floatformat:2 }} €
            <span id="rentabPctBadge"
                  class="badge-soft {% if rentabilidad_total >= 0 %}badge-profit{% else %}badge-loss{% endif %}"
                  data-rent="{{ rentabilidad_total|default:0 }}"
                  data-inv="{{ total_invertido|default:0 }}">
              {% if rentabilidad_total >= 0 %}▲{% else %}▼{% endif %}
              <span id="rentabPctText">
                {% if rentabilidad_pct_total is not None %}
                  {{ rentabilidad_pct_total|floatformat:2 }}
                {% endif %}
              </span> %
            </span>
          </div>
          <div class="kpi-meta">Ganancia/pérdida neta</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-4 mt-4">
    <div class="col-lg-6">
      <div class="card border-secondary h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Evolución Histórica</span>
          <div class="btn-group btn-group-sm" role="group" aria-label="Rango">
            <button class="btn btn-outline-light" data-dias="30">30D</button>
            <button class="btn btn-outline-light" data-dias="90">90D</button>
            <button class="btn btn-outline-light" data-dias="365">1A</button>
            <button class="btn btn-outline-light" data-dias="3650">Todo</button>
          </div>
        </div>
        <div class="card-body" style="height:360px;">
          <canvas id="lineChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card border-secondary h-100">
        <div class="card-header">Distribución por Acción</div>
        <div class="card-body" style="height:360px;">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Dividendos y Transacciones -->
  <div class="row g-4 mt-4">
    <!-- Dividendos -->
    <div class="col-lg-6">
      <div class="card border-secondary h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Dividendos</span>
          <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalDividendo">
            + Añadir dividendo
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover mb-0">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Ticker</th>
                <th class="text-end">Por acción</th>
                <th>Nota</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for d in dividendos %}
              <tr>
                <td>{{ d.fecha|date:"Y-m-d" }}</td>
                <td>{{ d.accion.ticker }}</td>
                <td class="text-end">{{ d.monto|default:0|floatformat:4 }} €</td>
                <td>{{ d.nota }}</td>
                <td class="text-end">
                  <a href="{% url 'dividendo_editar' d.id %}" class="btn btn-sm btn-outline-light">Editar</a>
                  <form action="{% url 'dividendo_borrar' d.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Borrar dividendo?');">Borrar</button>
                  </form>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">Sin dividendos.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Transacciones -->
    <div class="col-lg-6">
      <div class="card border-secondary h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Transacciones</span>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalTransaccion">+ Añadir</button>
            <a class="btn btn-sm btn-outline-light" href="{% url 'transacciones_export_csv' %}">Exportar CSV</a>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover mb-0">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Ticker</th>
                <th>Tipo</th>
                <th class="text-end">Cantidad</th>
                <th class="text-end">Precio</th>
                <th class="text-end">Comisión</th>
                <th class="text-end">Importe</th>
                <th class="text-end">Beneficio neto</th>
                <th class="text-end">Rentabilidad</th>
                <th>Nota</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for t in transacciones %}
              <tr>
                <td>{{ t.fecha|date:"Y-m-d" }}</td>
                <td>{{ t.ticker }}</td>
                <td class="text-capitalize">
                  {% if t.tipo == 'BUY' %}
                    <i class="bi bi-arrow-down-left-circle-fill icon-buy" title="Entrada (compra)"></i>
                    <span class="ms-1">Compra</span>
                  {% elif t.tipo == 'SELL' %}
                    <i class="bi bi-arrow-up-right-circle-fill icon-sell" title="Salida (venta)"></i>
                    <span class="ms-1">Venta</span>
                  {% else %}
                    <i class="bi bi-cash-coin" style="color:var(--accent-3)" title="Dividendo"></i>
                    <span class="ms-1">Dividendo</span>
                  {% endif %}
                </td>
                <td class="text-end">{{ t.cantidad|default:0|floatformat:2 }}</td>
                <td class="text-end">{{ t.precio|default:0|floatformat:2 }}</td>
                <td class="text-end">{{ t.comision|default:0|floatformat:2 }}</td>
                <td class="text-end">{{ t.importe|default:0|floatformat:2 }} €</td>
                <td class="text-end">
                  {% if t.beneficio is not None %}
                    {{ t.beneficio|floatformat:2 }} €
                  {% elif t.pnl is not None %}
                    {{ t.pnl|floatformat:2 }} €
                  {% else %}-{% endif %}
                </td>
                <td class="text-end">
                  {% if t.rentabilidad is not None %}
                    {{ t.rentabilidad|floatformat:2 }} %
                  {% elif t.rentab_pct is not None %}
                    {{ t.rentab_pct|floatformat:2 }} %
                  {% else %}-{% endif %}
                </td>
                <td>{{ t.nota }}</td>
                <td class="text-end">
                  <a href="{% url 'transaccion_editar' t.id %}" class="btn btn-sm btn-outline-light">Editar</a>
                  <form action="{% url 'transaccion_borrar' t.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Borrar transacción?');">Borrar</button>
                  </form>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="11" class="text-center text-muted">Sin transacciones.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  {% else %}
  <div class="alert alert-warning text-center mt-4">
    Debes <a href="{% url 'login' %}" class="alert-link">iniciar sesión</a> para acceder al Dashboard de rendimiento.
  </div>
  {% endif %}
</div>

<!-- ===== Modales mínimos (por si no usas includes) ===== -->
<div class="modal fade" id="modalDividendo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{% url 'dividendo_crear' %}">
      {% csrf_token %}
      <div class="modal-header"><h5 class="modal-title">Añadir dividendo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Acción (ID)</label>
          <input type="number" class="form-control" name="accion" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-control" name="fecha" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Monto por acción (€)</label>
          <input type="number" step="0.0001" class="form-control" name="monto" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Nota</label>
          <input type="text" class="form-control" name="nota">
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-primary">Guardar</button></div>
    </form>
  </div>
</div>

<div class="modal fade" id="modalTransaccion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{% url 'transaccion_crear' %}">
      {% csrf_token %}
      <div class="modal-header"><h5 class="modal-title">Añadir transacción</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Fecha</label>
            <input type="date" class="form-control" name="fecha" required>
          </div>
          <div class="col-6">
            <label class="form-label">Ticker</label>
            <input type="text" class="form-control" name="ticker" required>
          </div>
          <div class="col-6">
            <label class="form-label">Tipo</label>
            <select class="form-select" name="tipo" required>
              <option value="BUY">Compra</option>
              <option value="SELL">Venta</option>
              <option value="DIV">Dividendo</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label">Cantidad</label>
            <input type="number" step="1" class="form-control" name="cantidad" required>
          </div>
          <div class="col-6">
            <label class="form-label">Precio</label>
            <input type="number" step="0.01" class="form-control" name="precio" required>
          </div>
          <div class="col-6">
            <label class="form-label">Comisión</label>
            <input type="number" step="0.01" class="form-control" name="comision" value="0">
          </div>
          <div class="col-12">
            <label class="form-label">Nota</label>
            <input type="text" class="form-control" name="nota">
          </div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-primary">Guardar</button></div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{% if user.is_authenticated %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ====== Datos renderizados por Django como fallback ======
  const HIST_LABELS_CTX = {{ hist_labels|default:"[]"|safe }};
  const HIST_VALUES_CTX = {{ hist_values|default:"[]"|safe }};
  const DIST_LABELS_CTX = {{ dist_labels|default:"[]"|safe }};
  const DIST_VALUES_CTX = {{ dist_values|default:"[]"|safe }};

  // Paleta para charts
  const COLOR_LINE='#19e3b1', FILL_LINE='rgba(25, 227, 177, 0.15)';
  const COLORS_DONUT=['#4ea8ff','#19e3b1','#ff9f43','#ff5964','#8b5cf6','#06b6d4','#84cc16','#10b981','#f97316','#22c55e'];

  // ===== KPI: calcular % si no vino en contexto =====
  (function(){
    const badge = document.getElementById('rentabPctBadge');
    const out = document.getElementById('rentabPctText');
    if(badge && out && (!out.textContent || out.textContent.trim()==='')){
      const r = parseFloat(badge.dataset.rent||0), inv = parseFloat(badge.dataset.inv||0);
      const pct = inv>0 ? (r/inv*100) : 0;
      out.textContent = pct.toFixed(2);
    }
  })();

  // ===== Línea con gradiente =====
  let lineChart;
  function renderLinea(labels, values){
    const ctx = document.getElementById('lineChart').getContext('2d');
    if(lineChart) lineChart.destroy();
    const gradient = ctx.createLinearGradient(0,0,0,300);
    gradient.addColorStop(0, FILL_LINE);
    gradient.addColorStop(1, 'rgba(25, 227, 177, 0)');
    lineChart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ label:'Ganancia (€)', data:values, borderColor:COLOR_LINE, backgroundColor:gradient, tension:.35, pointRadius:0, fill:true, borderWidth:2 }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        scales:{ x:{ ticks:{ color:'#cfe7df' }, grid:{ color:'#1f2730' }}, y:{ ticks:{ color:'#cfe7df', callback:v=>v.toLocaleString('es-ES') }, grid:{ color:'#1f2730' } } },
        plugins:{ legend:{ labels:{ color:'#cfe7df' } }, tooltip:{ callbacks:{ label:c=>new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(c.parsed.y) } } }
      }
    });
  }
  function cargarLinea(dias){
    fetch(`/api/historico/?dias=${dias}`)
      .then(r=>r.ok?r.json():null)
      .then(d=>renderLinea(d?.labels||HIST_LABELS_CTX, d?.values||HIST_VALUES_CTX))
      .catch(()=>renderLinea(HIST_LABELS_CTX, HIST_VALUES_CTX));
  }
  document.querySelectorAll('[data-dias]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('[data-dias]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      cargarLinea(btn.dataset.dias);
    });
  });

  // ===== Donut con paleta =====
  let pieChart;
  function cargarDistribucion(){
    fetch("/api/cartera/")
      .then(r=>r.ok?r.json():null)
      .then(data=>{
        let labels=DIST_LABELS_CTX, valores=DIST_VALUES_CTX;
        if(data?.acciones?.length){ labels=data.acciones.map(a=>a.ticker); valores=data.acciones.map(a=>parseFloat(a.porcentaje_total)); }
        const ctx=document.getElementById('pieChart').getContext('2d');
        if(pieChart) pieChart.destroy();
        pieChart=new Chart(ctx,{
          type:'doughnut',
          data:{ labels, datasets:[{ data:valores, backgroundColor:COLORS_DONUT, borderWidth:0 }]},
          options:{
            responsive:true, maintainAspectRatio:false, cutout:'62%',
            plugins:{ legend:{ position:'bottom', labels:{ color:'#cfe7df' } }, tooltip:{ callbacks:{ label:(c)=>`${c.label}: ${Number(c.raw||0).toFixed(2)}%` } } }
          }
        });
      });
  }

  // ===== Init =====
  document.addEventListener("DOMContentLoaded", ()=>{
    renderLinea(HIST_LABELS_CTX, HIST_VALUES_CTX);
    const btnDefault=document.querySelector('[data-dias="365"]'); btnDefault?.classList.add('active');
    cargarLinea(365);
    cargarDistribucion();
    setInterval(cargarDistribucion, 60000);
  });
</script>
{% endif %}
{% endblock %}
