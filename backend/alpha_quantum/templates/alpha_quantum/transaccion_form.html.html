{% extends "alpha_quantum/layout.html" %}
{% block content %}
<div class="container" style="max-width:680px">
  <h3 class="mb-3">Nueva Transacción</h3>

  <form method="post" class="card p-3 bg-dark text-light border-secondary" id="txForm">
    {% csrf_token %}
    <div class="row g-3">
      <!-- Ticker (UI dual: input para BUY, select para SELL) -->
      <div class="col-md-4">
        <label class="form-label">Ticker</label>

        <!-- Input libre (se usa en COMPRAS) -->
        <input id="tickerInput"
               class="form-control bg-dark text-light border-secondary"
               placeholder="AAPL" autocomplete="off">

        <!-- Select restringido (se usa en VENTAS) -->
        <select id="tickerSelect"
                class="form-select bg-dark text-light border-secondary d-none">
        </select>

        <!-- Campo real que viaja al servidor -->
        <input type="hidden" name="ticker" id="tickerHidden" />
        <small id="posInfo" class="text-muted d-block mt-1"></small>
      </div>

      <div class="col-md-4">
        <label class="form-label">Tipo</label>
        <select name="tipo" id="tipo"
                class="form-select bg-dark text-light border-secondary" required>
          <option value="BUY">Compra</option>
          <option value="SELL">Venta</option>
          <option value="DIV">Dividendo</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Fecha</label>
        <input type="date" name="fecha"
               class="form-control bg-dark text-light border-secondary" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">Cantidad</label>
        <input type="number" step="0.0001" name="cantidad" id="cantidad"
               class="form-control bg-dark text-light border-secondary" required>
        <small id="maxInfo" class="text-muted"></small>
      </div>

      <div class="col-md-4">
        <label class="form-label">Precio</label>
        <input type="number" step="0.0001" name="precio" id="precio"
               class="form-control bg-dark text-light border-secondary" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">Comisión</label>
        <input type="number" step="0.0001" name="comision"
               class="form-control bg-dark text-light border-secondary" value="0">
      </div>

      <div class="col-12">
        <label class="form-label">Nota</label>
        <input name="nota" class="form-control bg-dark text-light border-secondary">
      </div>
    </div>

    <div class="mt-3 d-flex align-items-center gap-2">
      <button class="btn btn-primary">Guardar</button>
      <a href="{% url 'dashboard' %}" class="btn btn-outline-light">Cancelar</a>
    </div>
  </form>
</div>

<script>
  // Posiciones del usuario por ticker (inyectadas desde la vista)
  const POS = {{ posiciones_json|default:"{}"|safe }};

  const tipoSel       = document.getElementById('tipo');
  const tickerInput   = document.getElementById('tickerInput');
  const tickerSelect  = document.getElementById('tickerSelect');
  const tickerHidden  = document.getElementById('tickerHidden');
  const cantidadInp   = document.getElementById('cantidad');
  const precioInp     = document.getElementById('precio');
  const maxInfo       = document.getElementById('maxInfo');
  const posInfo       = document.getElementById('posInfo');

  // Helper: pasa el UI actual al hidden 'ticker' que viaja al servidor
  function syncHiddenTicker() {
    if (tipoSel.value === 'SELL') {
      tickerHidden.value = (tickerSelect.value || '').toUpperCase();
    } else {
      tickerHidden.value = (tickerInput.value || '').toUpperCase();
    }
  }

  // Rellena el select con los tickers disponibles (cantidad > 0)
  function populateSellTickers() {
    tickerSelect.innerHTML = '';
    const entries = Object.entries(POS).filter(([tk, q]) => Number(q) > 0);
    if (entries.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Sin posiciones';
      tickerSelect.appendChild(opt);
      tickerSelect.disabled = true;
    } else {
      tickerSelect.disabled = false;
      for (const [tk, q] of entries) {
        const opt = document.createElement('option');
        opt.value = tk;
        opt.textContent = `${tk} — ${q}`;
        tickerSelect.appendChild(opt);
      }
    }
  }

  // Limita cantidad cuando es venta
  function enforceSellMax() {
    if (tipoSel.value !== 'SELL') {
      cantidadInp.removeAttribute('max');
      maxInfo.textContent = '';
      posInfo.textContent = '';
      return;
    }
    const tk = tickerSelect.value;
    const max = Number(POS[tk] || 0);
    if (max > 0) {
      cantidadInp.setAttribute('max', String(max));
      cantidadInp.setAttribute('min', '0.0001');
      maxInfo.textContent = `Máximo permitido: ${max}`;
      posInfo.textContent = `Disponibles en cartera: ${max} ${tk}`;
      // Clamp si el usuario teclea más de lo que tiene
      cantidadInp.addEventListener('input', () => {
        const val = Number(cantidadInp.value || 0);
        if (val > max) cantidadInp.value = String(max);
      }, { once: true });
    } else {
      cantidadInp.removeAttribute('max');
      maxInfo.textContent = 'No hay acciones disponibles para vender.';
      posInfo.textContent = '';
    }
  }

  // Cambia la UI según el tipo
  function onTipoChange() {
    const t = tipoSel.value;

    if (t === 'SELL') {
      // Mostrar SELECT, ocultar INPUT de ticker
      tickerSelect.classList.remove('d-none');
      tickerInput.classList.add('d-none');

      populateSellTickers();
      enforceSellMax();

      // Precio requerido en venta
      precioInp.required = true;

      syncHiddenTicker();
    } else {
      // Compra o Dividendo → ticker libre
      tickerSelect.classList.add('d-none');
      tickerInput.classList.remove('d-none');
      cantidadInp.removeAttribute('max');
      maxInfo.textContent = '';
      posInfo.textContent = '';

      // En dividendos puedes querer precio opcional:
      // (si lo deseas opcional, descomenta la línea)
      // precioInp.required = (t !== 'DIV');

      syncHiddenTicker();
    }
  }

  // Uppercase automático al teclear en el input de ticker
  tickerInput.addEventListener('input', () => {
    tickerInput.value = tickerInput.value.toUpperCase().trim();
    syncHiddenTicker();
  });

  // Sincroniza al cambiar el select de ticker (ventas)
  tickerSelect.addEventListener('change', () => {
    enforceSellMax();
    syncHiddenTicker();
  });

  // Inicialización
  onTipoChange();
  tipoSel.addEventListener('change', onTipoChange);

  // Asegura que antes de enviar, el hidden lleve el valor correcto
  document.getElementById('txForm').addEventListener('submit', () => {
    syncHiddenTicker();
  });
</script>
{% endblock %}
