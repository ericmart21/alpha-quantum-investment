{% extends 'alpha_quantum/layout.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">ğŸ—“ï¸ Calendario Financiero</h2>

    <!-- Filtros avanzados -->
    <form method="get" class="row g-3 mb-4 align-items-end">
        <!-- Filtro por tipo de evento -->
        <div class="col-md-4">
            <label for="tipo_evento" class="form-label">Tipo de evento:</label>
            <select name="tipo_evento" id="tipo" class="form-select">
                <option value="" {% if not tipo_actual %}selected{% endif %}>ğŸ“‚ Todos</option>
                <option value="resultado" {% if tipo_actual == 'resultado' %}selected{% endif %}>ğŸ“Š Resultados</option>
                <option value="dividendo" {% if tipo_actual == 'dividendo' %}selected{% endif %}>ğŸ’¸ Dividendos</option>
                <option value="transaccion" {% if tipo_actual == 'transaccion' %}selected{% endif %}>ğŸ” Transacciones</option>
            </select>
        </div>

        <!-- Filtro por rango de tiempo -->
        <div class="col-md-4">
            <label for="tiempo" class="form-label">Rango de tiempo:</label>
            <select name="tiempo" id="tiempo" class="form-select">
                <option value="" {% if not tiempo_actual %}selected{% endif %}>â³ Todo el tiempo</option>
                <option value="30_dias" {% if tiempo_actual == '30_dias' %}selected{% endif %}>ğŸ—“ï¸ Ãšltimos 30 dÃ­as</option>
                <option value="3_meses" {% if tiempo_actual == '3_meses' %}selected{% endif %}>ğŸ“† Ãšltimos 3 meses</option>
                <option value="6_meses" {% if tiempo_actual == '6_meses' %}selected{% endif %}>ğŸ—“ï¸ Ãšltimos 6 meses</option>
                <option value="1_ano" {% if tiempo_actual == '1_ano' %}selected{% endif %}>ğŸ“… Ãšltimo aÃ±o</option>
            </select>
        </div>

        <!-- Filtro por ticker -->
        <div class="col-md-3">
            <label for="ticker" class="form-label">Filtrar por ticker:</label>
            <input type="text" name="ticker" id="ticker" class="form-control" placeholder="Ej: AAPL" value="{{ ticker_actual }}">
        </div>

        <div class="col-md-1">
            <button type="submit" class="btn btn-primary w-100">ğŸ”</button>
        </div>
    </form>

    <!-- Tabla de eventos -->
    {% if eventos %}
    <table class="table table-dark table-striped table-hover mt-4">
        <thead class="table-light text-dark">
            <tr>
                <th>ğŸ“… Fecha</th>
                <th>ğŸ”– Ticker</th>
                <th>ğŸ“ Tipo</th>
                <th>ğŸ“Œ TÃ­tulo</th>
                <th>ğŸ§¾ DescripciÃ³n</th>
            </tr>
        </thead>
        <tbody>
            {% for evento in eventos %}
            <tr>
                <td>{{ evento.fecha }}</td>
                <td>{{ evento.ticker|default:"-" }}</td>
                <td>
                    {% if evento.tipo_evento == "resultado" %}
                        ğŸ“Š Resultados
                    {% elif evento.tipo_evento == "dividendo" %}
                        ğŸ’¸ Dividendo
                    {% elif evento.tipo_evento == "transaccion" %}
                        ğŸ” TransacciÃ³n
                    {% else %}
                        ğŸ“ Otro
                    {% endif %}
                </td>
                <td>{{ evento.titulo }}</td>
                <td>{{ evento.descripcion }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No hay eventos para mostrar con los filtros seleccionados.</p>
    {% endif %}

    <!-- Calendario visual -->
    <div id="calendar" class="mt-5 bg-white rounded shadow p-3"></div>
</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            themeSystem: 'bootstrap5',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listMonth'
            },
            events: [
                {% for evento in eventos %}
                {
                    title: "{{ evento.ticker }} - {% if evento.tipo_evento == 'resultado' %}Resultados{% elif evento.tipo_evento == 'dividendo' %}Dividendo{% elif evento.tipo_evento == 'transaccion' %}TransacciÃ³n{% else %}Evento{% endif %}",
                    start: "{{ evento.fecha|date:'Y-m-d' }}",
                    color: "{% if evento.tipo_evento == 'resultado' %}#0d6efd{% elif evento.tipo_evento == 'dividendo' %}#198754{% elif evento.tipo_evento == 'transaccion' %}#ffc107{% else %}#6c757d{% endif %}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        });

        calendar.render();
    });
</script>
{% endblock %}
