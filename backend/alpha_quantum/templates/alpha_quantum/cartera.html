{% extends "alpha_quantum/layout.html" %}
{% load static %}

{% block title %}Cartera â€¢ Alpha Quantum{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
    :root{
        --bg:#0f1317;--panel:#151a21;--panel2:#10161d;--border:#232a33;
        --text:#e7eef7;--muted:#9fb1c1;--ok:#19e3b1;--info:#4ea8ff;--warn:#ff9f43;--down:#ff5964
    }
    body{background:var(--bg);color:var(--text)}
    .card{background:var(--panel)!important;border:1px solid var(--border)!important;border-radius:16px}
    .card-header{background:var(--panel2)!important;border-bottom:1px solid var(--border)!important;border-top-left-radius:16px;border-top-right-radius:16px}
    .kpi{display:flex;gap:14px;align-items:center;padding:18px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)),var(--panel);border:1px solid var(--border)}
    .kpi .ico{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .kpi .meta{color:var(--muted);font-size:.9rem}
    .kpi .val{font-weight:800;font-size:1.8rem}
    .kpi.ok .ico{background:rgba(25,227,177,.12);color:var(--ok);border:1px solid rgba(25,227,177,.35)}
    .kpi.info .ico{background:rgba(78,168,255,.12);color:var(--info);border:1px solid rgba(78,168,255,.35)}
    .kpi.warn .ico{background:rgba(255,159,67,.12);color:var(--warn);border:1px solid rgba(255,159,67,.35)}
    .chip{padding:.35rem .8rem;border-radius:999px;border:1px solid var(--border);background:var(--panel2);color:var(--muted)}
    .chip.active{background:#102822;border-color:#1f7a66;color:#9af0d8}
    .badge-soft{border:1px solid var(--border);background:#0f161a;color:#cfe7df;padding:.25rem .55rem;border-radius:10px;font-size:.75rem}
    .badge-up{color:var(--ok);border-color:rgba(25,227,177,.35)}
    .badge-down{color:var(--down);border-color:rgba(255,89,100,.35)}
    .table thead th{color:var(--muted);border-color:var(--border)}
    .table tbody td{border-color:#1f2937}
    .state-ok{background:#102822;border:1px solid #1f7a66;border-radius:10px;color:#9af0d8;padding:.15rem .55rem}
    .state-bad{background:#2a1317;border:1px solid #8a303a;border-radius:10px;color:#ffc8cd;padding:.15rem .55rem}
    .spark-cell{width:130px}
    .spark{height:28px;width:120px}
    .page-title{font-weight:800;letter-spacing:.3px}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="page-title">ðŸ“‘ Mi Cartera de InversiÃ³n</h2>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-lg-4">
      <div class="kpi ok">
        <div class="ico"><i class="bi bi-wallet2 fs-5"></i></div>
        <div>
          <div class="meta">Valor actual</div>
          <div class="val">{{ valor_actual|floatformat:2 }} â‚¬</div>
          <div class="meta">Suma de todas las posiciones</div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="kpi info">
        <div class="ico"><i class="bi bi-cart-check fs-5"></i></div>
        <div>
          <div class="meta">Total invertido</div>
          <div class="val">{{ total_invertido|floatformat:2 }} â‚¬</div>
          <div class="meta">Coste total de compra</div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="kpi {% if rentab_total_eur >= 0 %}ok{% else %}warn{% endif %}">
        <div class="ico"><i class="bi bi-graph-up-arrow fs-5"></i></div>
        <div>
          <div class="meta">Rentabilidad</div>
          <div class="val d-flex align-items-center gap-2">
            {{ rentab_total_eur|floatformat:2 }} â‚¬
            <span class="badge-soft {% if rentab_total_eur >= 0 %}badge-up{% else %}badge-down{% endif %}">
              {% if rentab_total_eur >= 0 %}â–²{% else %}â–¼{% endif %} {{ rentab_total_pct|floatformat:2 }} %
            </span>
          </div>
          <div class="meta">Neta de inversiÃ³n</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chips (placeholder para futuro) -->
  <div class="d-flex gap-2 mb-3">
    <span class="chip active" data-alloc="ticker">Por Ticker</span>
    <span class="chip" data-alloc="sector" title="Requiere campo sector en modelo Accion">Por Sector</span>
    <span class="chip" data-alloc="divisa" title="Requiere campo divisa en modelo Accion">Por Divisa</span>
  </div>

  <!-- Tabla posiciones -->
  <div class="card mb-3">
    <div class="card-header">Posiciones</div>
    <div class="table-responsive p-2">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Ticker</th>
            <th class="text-end">Precio Compra</th>
            <th class="text-end">Precio Actual</th>
            <th class="text-end">Cantidad</th>
            <th class="text-end">Valor Total (â‚¬)</th>
            <th class="text-end">Rentabilidad (â‚¬)</th>
            <th class="text-end">Rentabilidad (%)</th>
            <th class="text-end">% del Total</th>
            <th class="text-center">Estado</th>
            <th class="text-center spark-cell">Spark</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td class="fw-semibold">{{ it.ticker }}</td>
            <td class="text-end">{{ it.precio_compra|floatformat:2 }}</td>
            <td class="text-end">{{ it.precio_actual|floatformat:2 }}</td>
            <td class="text-end">{{ it.cantidad }}</td>
            <td class="text-end">{{ it.valor_total|floatformat:2 }} â‚¬</td>
            <td class="text-end {% if it.pnl_eur < 0 %}text-danger{% else %}text-success{% endif %}">
              {{ it.pnl_eur|floatformat:2 }} â‚¬
            </td>
            <td class="text-end {% if it.pnl_pct < 0 %}text-danger{% else %}text-success{% endif %}">
              {{ it.pnl_pct|floatformat:2 }} %
            </td>
            <td class="text-end">{{ it.pct_total|floatformat:2 }} %</td>
            <td class="text-center">
              {% if it.pnl_eur >= 0 %}
                <span class="state-ok">Ganancia</span>
              {% else %}
                <span class="state-bad">PÃ©rdida</span>
              {% endif %}
            </td>
            <td class="text-center spark-cell">
              <canvas class="spark" id="spark-{{ it.ticker }}"></canvas>
            </td>
            <td class="text-end">
              <a href="{% url 'editar_accion' it.id %}" class="btn btn-sm btn-outline-light">Editar</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="11" class="text-center text-muted">No tienes posiciones.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="row g-3">
    <!-- Donut -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">DistribuciÃ³n de la Cartera</div>
        <div class="card-body" style="height:380px">
          <canvas id="allocChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Rebalanceo -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Rebalanceo sugerido (objetivo igual ponderado)</span>
        </div>
        <div class="table-responsive p-2">
          <table class="table table-dark table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Ticker</th>
                <th class="text-end">Objetivo</th>
                <th class="text-end">Actual</th>
                <th class="text-end">Diferencia</th>
                <th class="text-end">Sugerencia</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rebalance %}
              <tr>
                <td class="fw-semibold">{{ r.ticker }}</td>
                <td class="text-end">{{ r.target|floatformat:2 }} %</td>
                <td class="text-end">{{ r.actual|floatformat:2 }} %</td>
                <td class="text-end {% if r.diff < 0 %}text-danger{% elif r.diff > 0 %}text-success{% endif %}">
                  {% if r.diff > 0 %}+{% endif %}{{ r.diff|floatformat:2 }} %
                </td>
                <td class="text-end">
                  {% if r.sug == 'buy' %}
                    <span class="state-ok">Comprar</span>
                  {% elif r.sug == 'sell' %}
                    <span class="state-bad">Vender</span>
                  {% else %}
                    <span class="badge-soft">OK</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted">Sin datos.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ===== Donut por Ticker (/api/cartera/)
  const COLORS=['#4ea8ff','#19e3b1','#ff9f43','#ff5964','#8b5cf6','#06b6d4','#84cc16','#10b981','#f97316','#22c55e'];
  let allocChart;

  function renderAlloc(labels,values){
    const ctx=document.getElementById('allocChart').getContext('2d');
    if(allocChart) allocChart.destroy();
    allocChart=new Chart(ctx,{
      type:'doughnut',
      data:{labels,datasets:[{data:values,backgroundColor:COLORS,borderWidth:0}]},
      options:{
        responsive:true,maintainAspectRatio:false,cutout:'62%',
        plugins:{
          legend:{position:'bottom',labels:{color:'#cfe7df'}},
          tooltip:{callbacks:{label:c=>`${c.label}: ${Number(c.raw||0).toFixed(2)}%`}}
        }
      }
    });
  }

  function loadTickerAlloc(){
    fetch("{% url 'api_cartera' %}")
      .then(r=>r.ok?r.json():null)
      .then(d=>{
        const labels=(d?.acciones||[]).map(a=>a.ticker);
        const values=(d?.acciones||[]).map(a=>parseFloat(a.porcentaje_total));
        renderAlloc(labels,values);
      })
      .catch(()=>{});
  }

  document.querySelectorAll('[data-alloc]').forEach(chip=>{
    chip.addEventListener('click',()=>{
      document.querySelectorAll('[data-alloc]').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      // por ahora solo 'ticker'
      loadTickerAlloc();
    });
  });

  // ===== Sparklines por fila (/api/sparkline/?ticker=XXX&days=30)
  function drawSpark(id,values){
    const el=document.getElementById(id);
    if(!el) return;
    new Chart(el.getContext('2d'),{
      type:'line',
      data:{labels:values.map((_,i)=>i),datasets:[{data:values,borderColor:'#19e3b1',backgroundColor:'rgba(25,227,177,0.12)',tension:.35,pointRadius:0,fill:true,borderWidth:1.8}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:false}}}
    });
  }

  function loadSparklines(){
    Array.from(document.querySelectorAll('.spark')).forEach(cv=>{
      const ticker=cv.id.replace('spark-','');
      fetch(`{% url 'api_sparkline' %}?ticker=${encodeURIComponent(ticker)}&days=30`)
        .then(r=>r.ok?r.json():null)
        .then(d=>drawSpark(cv.id,d?.values||[]))
        .catch(()=>{});
    });
  }

  document.addEventListener('DOMContentLoaded',()=>{
    loadTickerAlloc();
    loadSparklines();
  });
</script>
{% endblock %}
