{% extends "alpha_quantum/layout.html" %}
{% block content %}
<style>
  /* Tablas y formularios (oscuro) */
  .table thead th {
    background-color: #1a1a1a !important;
    color: #fff !important;
    border-color: #444 !important
  }

  .table-striped tbody tr:nth-of-type(odd) td {
    background-color: #242424 !important;
    color: #fff !important
  }

  .table-striped tbody tr:nth-of-type(even) td {
    background-color: #1a1a1a !important;
    color: #fff !important
  }

  .table-striped tbody tr:hover td {
    background-color: #333 !important
  }

  .table td a {
    color: #fff !important
  }

  .form-control,
  .form-select {
    background-color: #1e1e1e;
    color: #fff;
    border-color: #444
  }

  .form-control::placeholder {
    color: #aaa
  }

  /* KPI base */
  .kpi-card {
    border: 1px solid transparent;
    border-radius: .75rem;
    padding: 1rem
  }

  .kpi-title {
    font-size: .85rem;
    margin-bottom: .25rem;
    opacity: .9
  }

  .kpi-value {
    font-size: 1.25rem;
    font-weight: 700
  }

  /* Colores KPI (alineados al gráfico) */
  .kpi-card.ingresos {
    background: #22c55e;
    border-color: #16a34a
  }

  .kpi-card.gastos {
    background: #ef4444;
    border-color: #dc2626
  }

  .kpi-card.gastos-alquiler {
    background: #b91c1c;
    border-color: #991b1b
  }

  .kpi-card.balance-total {
    background: #3b82f6;
    border-color: #2563eb
  }

  .kpi-card.beneficio-prop {
    background: #14b8a6;
    border-color: #0d9488
  }

  .kpi-card.balance-prest {
    background: #f59e0b;
    border-color: #d97706
  }

  /* Texto de KPI siempre blanco */
  .kpi-card.ingresos .kpi-title,
  .kpi-card.gastos .kpi-title,
  .kpi-card.gastos-alquiler .kpi-title,
  .kpi-card.balance-total .kpi-title,
  .kpi-card.beneficio-prop .kpi-title,
  .kpi-card.balance-prest .kpi-title,
  .kpi-card.ingresos .kpi-value,
  .kpi-card.gastos .kpi-value,
  .kpi-card.gastos-alquiler .kpi-value,
  .kpi-card.balance-total .kpi-value,
  .kpi-card.beneficio-prop .kpi-value,
  .kpi-card.balance-prest .kpi-value {
    color: #fff
  }

  /* Tarjeta del gráfico y controles */
  .chart-card {
    background: #0f1115;
    border: 1px solid #2b2f3a;
    border-radius: .5rem
  }

  .chart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: .75rem 1rem;
    border-bottom: 1px solid #2b2f3a;
    color: #e5e7eb
  }

  .chart-body {
    padding: 1rem
  }

  .chart-wrap {
    position: relative;
    width: 100%;
    height: 600px
  }

  .range-btn {
    border: 1px solid #475569;
    background: #0b1220;
    color: #e5e7eb;
    padding: .25rem .5rem;
    border-radius: .375rem;
    font-size: .875rem
  }

  .range-btn.active {
    background: #334155
  }

  .range-btn+.range-btn {
    margin-left: .25rem
  }
</style>

<div class="container mt-4">
  <h2>Flujo de Caja Mensual</h2>

  <!-- KPIs (con colores) -->
  <div class="row g-3 mt-2">
    <div class="col-md-2 col-6">
      <div class="kpi-card ingresos">
        <div class="kpi-title">Ingresos</div>
        <div class="kpi-value">{{ total_ingresos }} €</div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="kpi-card beneficio-prop">
        <div class="kpi-title">Beneficio Neto Propiedades</div>
        <div class="kpi-value">{{ beneficio_total_propiedades }} €</div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="kpi-card gastos">
        <div class="kpi-title">Gastos</div>
        <div class="kpi-value">{{ total_gastos }} €</div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="kpi-card gastos-alquiler">
        <div class="kpi-title">Gastos Alquiler</div>
        <div class="kpi-value">{{ total_gastos_alquiler }} €</div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="kpi-card balance-prest">
        <div class="kpi-title">Balance Pend. Préstamos</div>
        <div class="kpi-value">{{ balance_pendiente_prestamos }} €</div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="kpi-card balance-total">
        <div class="kpi-title">Balance Total</div>
        <div class="kpi-value">{{ balance_total }} €</div>
      </div>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="chart-card mt-4 mb-5">
    <div class="chart-header">
      <span>Flujo de Caja</span>
      <div>
        <button class="range-btn active" data-range="3">3M</button>
        <button class="range-btn" data-range="6">6M</button>
        <button class="range-btn" data-range="12">1A</button>
        <button class="range-btn" data-range="60">5A</button>
        <button class="range-btn" data-range="0">TODO</button>
        <button id="resetZoom" class="range-btn ms-2">Reset Zoom</button>
      </div>
    </div>
    <div class="chart-body">
      <div class="chart-wrap"><canvas id="graficoCashflow"></canvas></div>
    </div>
  </div>

  <!-- Ingresos / Gastos -->
  <div id="ingresos" class="seccion">
    <h4>Ingresos / Gastos</h4>
    <button class="btn btn-success mb-2" data-bs-toggle="modal" data-bs-target="#modalIngreso">
      + Añadir Ingreso
    </button>
    <button class="btn btn-danger mb-2 ms-2" data-bs-toggle="modal" data-bs-target="#modalGasto">
      + Añadir Gasto
    </button>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Categoría</th>
          <th>Monto</th>
          <th>Descripción</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for r in registros %}
        <tr>
          <td>{{ r.date }}</td>
          <td>{{ r.category|title }}</td>
          <td>{{ r.tipo_ingreso|default_if_none:"-" }}</td>
          <td>{{ r.amount }} €</td>
          <td>{{ r.description }}</td>
          <td>
            <a href="{% url 'editar_registro' r.id %}" class="btn btn-sm btn-primary">Editar</a>
            <form action="{% url 'eliminar_registro' r.id %}" method="post" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-sm btn-danger" onclick="return confirm('¿Eliminar registro?')">Borrar</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">Sin registros.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Propiedades -->
  <div id="propiedades" class="seccion mt-5">
    <div class="d-flex justify-content-between align-items-center">
      <h4>Propiedades en Alquiler</h4>
      <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalPropiedad">+ Añadir
        Propiedad</button>
    </div>
    <table class="table table-striped mt-2">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Ingreso</th>
          <th>Hipoteca</th>
          <th>Meses Restantes</th>
          <th>Mantenimiento</th>
          <th>Beneficio Neto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for p in propiedades %}
        <tr>
          <td>{{ p.nombre }}</td>
          <td>{{ p.ingreso_mensual }} €</td>
          <td>{{ p.hipoteca_mensual }} €</td>
          <td>{{ p.meses_restantes_hipoteca }}</td>
          <td>{{ p.gastos_mantenimiento }} €</td>
          <td>{{ p.beneficio_neto }} €</td>
          <td>
            <a href="{% url 'editar_propiedad' p.id %}" class="btn btn-sm btn-primary">Editar</a>
            <form action="{% url 'eliminar_propiedad' p.id %}" method="post" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-sm btn-danger" onclick="return confirm('¿Eliminar propiedad?')">Borrar</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">Sin propiedades.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Préstamos -->
  <div id="prestamos" class="seccion mt-5">
    <div class="d-flex justify-content-between align-items-center">
      <h4>Préstamos Personales</h4>
      <!-- AHORA abre el modal en lugar de navegar -->
      <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalPrestamo">
        + Añadir Préstamo
      </button>
    </div>
    <table class="table table-striped mt-2">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Cuota Mensual</th>
          <th>Meses Restantes</th>
          <th>Balance Pendiente</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for p in prestamos %}
        <tr>
          <td>{{ p.nombre }}</td>
          <td>{{ p.cuota_mensual }} €</td>
          <td>{{ p.meses_restantes }}</td>
          <td>{{ p.balance_actual }} €</td>
          <td>
            <a class="btn btn-sm btn-primary" href="{% url 'editar_prestamo' p.id %}">Editar</a>
            <form action="{% url 'eliminar_prestamo' p.id %}" method="post" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-sm btn-danger" onclick="return confirm('¿Eliminar préstamo?')">Borrar</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center text-muted">Sin préstamos.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modales -->
{% include 'alpha_quantum/cashflow/modales_ingreso_gasto.html' %}
{% include 'alpha_quantum/cashflow/modal_propiedad.html' %}
{% include 'alpha_quantum/cashflow/modal_prestamo.html' %}

<!-- Librerías -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>

<script>
  /* === Datos Django === */
  const LABELS_ALL = {{ labels_grafico| safe }};
  const DATA_ING = {{ valores_ingresos| safe }};
  const DATA_GAS = {{ valores_gastos| safe }};
  const DATA_BAL = {{ valores_balance| safe }};
  const DATA_HIP = {{ valores_hipoteca_restante| safe }};
  const DATA_CUENTAS = {{ valores_balance_cuentas| safe }};

  /* === Colores (coinciden con KPI) === */
  const COLORS = {
    ing: '#22c55e',  // verde
    gas: '#ef4444',  // rojo
    hip: '#b91c1c',  // rojo oscuro
    bal: '#3b82f6',  // azul
    cue: '#f59e0b'   // amarillo
  };

  function sliceLastN(n) {
    if (!n || n <= 0) return {
      labels: [...LABELS_ALL], ing: [...DATA_ING], gas: [...DATA_GAS],
      bal: [...DATA_BAL], hip: [...DATA_HIP], cue: [...DATA_CUENTAS],
    };
    const s = Math.max(0, LABELS_ALL.length - n);
    return {
      labels: LABELS_ALL.slice(s),
      ing: DATA_ING.slice(s),
      gas: DATA_GAS.slice(s),
      bal: DATA_BAL.slice(s),
      hip: DATA_HIP.slice(s),
      cue: DATA_CUENTAS.slice(s),
    };
  }

  if (window.__cashflowChart) { try { window.__cashflowChart.destroy(); } catch (e) { } }

  let currentRange = 3;
  let sliced = sliceLastN(currentRange);
  const ctx = document.getElementById('graficoCashflow').getContext('2d');

  window.__cashflowChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: sliced.labels,
      datasets: [
        { label: 'Ingresos', order: 1, data: sliced.ing, borderColor: COLORS.ing, pointBackgroundColor: COLORS.ing, pointBorderColor: COLORS.ing, fill: false, borderWidth: 3, pointRadius: 2, tension: .35 },
        { label: 'Gastos', order: 2, data: sliced.gas, borderColor: COLORS.gas, pointBackgroundColor: COLORS.gas, pointBorderColor: COLORS.gas, fill: false, borderWidth: 3, pointRadius: 2, tension: .35 },
        { label: 'Préstamos/Hipoteca', order: 3, data: sliced.hip, borderColor: COLORS.hip, pointBackgroundColor: COLORS.hip, pointBorderColor: COLORS.hip, fill: false, borderWidth: 3, pointRadius: 2, tension: .35 },
        { label: 'Balance', order: 4, data: sliced.bal, borderColor: COLORS.bal, pointBackgroundColor: COLORS.bal, pointBorderColor: COLORS.bal, fill: false, borderWidth: 3, pointRadius: 2, tension: .35 },
        { label: 'Balance de Cuentas', order: 5, data: sliced.cue, borderColor: COLORS.cue, pointBackgroundColor: COLORS.cue, pointBorderColor: COLORS.cue, fill: false, borderWidth: 3, pointRadius: 2, tension: .35 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      elements: { line: { borderWidth: 3 }, point: { radius: 2 } },
      plugins: {
        legend: { labels: { color: '#fff', usePointStyle: true, boxWidth: 10, boxHeight: 10 } },
        tooltip: { mode: 'index', intersect: false, backgroundColor: '#222', titleColor: '#fff', bodyColor: '#fff' },
        zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }, pan: { enabled: true, mode: 'xy' } }
      },
      interaction: { mode: 'nearest', axis: 'x', intersect: false },
      scales: { x: { ticks: { color: '#fff' }, grid: { color: '#444' } }, y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: '#444' } } }
    }
  });

  function setActive(btn) {
    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  document.querySelectorAll('.range-btn[data-range]').forEach(btn => {
    btn.addEventListener('click', () => {
      const n = Number(btn.dataset.range);
      const s = sliceLastN(n);
      const ch = window.__cashflowChart;
      ch.data.labels = s.labels;
      ch.data.datasets[0].data = s.ing;
      ch.data.datasets[1].data = s.gas;
      ch.data.datasets[2].data = s.hip;
      ch.data.datasets[3].data = s.bal;
      ch.data.datasets[4].data = s.cue;
      ch.update();
      setActive(btn);
    });
  });

  const rz = document.getElementById('resetZoom');
  if (rz) rz.addEventListener('click', () => window.__cashflowChart.resetZoom());
</script>
{% endblock %}