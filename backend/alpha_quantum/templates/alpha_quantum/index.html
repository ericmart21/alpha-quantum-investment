{% extends "alpha_quantum/layout.html" %}
{% load static %}
{% block title %}Mi Cartera de Inversión{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-3">Mi Cartera de Inversión</h2>
        </div>
    </div>

    {% if user.is_authenticated %}
    <!-- Tabla de posiciones y gráfico -->
    <div class="row g-3">
        <!-- Tabla de posiciones -->
        <div class="col-12 col-lg-6">
            <div class="card bg-dark text-light shadow-sm h-100">
                <div class="card-header border-secondary">Posiciones</div>
                <div class="table-responsive">
                    <table class="table table-dark table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Cantidad</th>
                                <th class="text-end">Precio Compra (€)</th>
                                <th class="text-end">Fecha</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for acc in acciones %}
                            <tr>
                                <td>{{ acc.ticker }}</td>
                                <td>{{ acc.cantidad }}</td>
                                <td class="text-end">{{ acc.precio_compra|floatformat:2 }}</td>
                                <td class="text-end">{{ acc.fecha|date:"d \d\e F Y" }}</td>
                                <td class="text-end">
                                    <a href="{% url 'editar_accion' pk=acc.pk %}" class="btn btn-sm btn-outline-warning">✏️ Editar</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center">Sin posiciones</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gráfico circular -->
        <div class="col-12 col-lg-6 d-flex align-items-stretch">
            <div class="card bg-dark text-light shadow-sm w-100">
                <div class="card-header border-secondary">Distribución</div>
                <div class="card-body d-flex justify-content-center">
                    <canvas id="pieChart" style="max-height:360px"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Transacciones (placeholder) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark text-light shadow-sm">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <span>Transacciones recientes</span>
                    <a href="#" class="btn btn-sm btn-outline-secondary">Ver todas</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Acción</th>
                                <th>Tipo</th>
                                <th class="text-end">Importe</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-transacciones">
                            <!-- Se rellenará vía JS/API -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Si no está autenticado -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning text-center mt-4" role="alert">
                Debes <a href="{% url 'login' %}" class="alert-link">iniciar sesión</a> para ver tu cartera de inversión.
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if user.is_authenticated %}
<!-- Scripts solo si está autenticado -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const datosAcciones = JSON.parse('{{ acciones_json|escapejs }}');
    const labels = datosAcciones.map(a => a.nombre);
    const cantidades = datosAcciones.map(a => a.cantidad);

    const ctx = document.getElementById('pieChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels,
            datasets: [{
                data: cantidades,
                backgroundColor: ['#3498db','#2ecc71','#e67e22','#9b59b6','#e74c3c','#f1c40f','#95a5a6']
            }]
        },
        options: {
            plugins:{legend:{position:'bottom',labels:{color:'#fff'}}}
        }
    });

    // TODO: fetch transacciones vía API y rellenar tabla
</script>
{% endif %}
{% endblock %}
