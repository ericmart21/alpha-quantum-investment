{% extends "alpha_quantum/layout.html" %}
{% block content %}
<style>
    .table thead th {
        background-color: #1a1a1a !important;
        color: white !important;
        border-color: #444 !important;
    }
    .table-striped tbody tr:nth-of-type(odd) td {
        background-color: #242424 !important;
        color: white !important;
    }
    .table-striped tbody tr:nth-of-type(even) td {
        background-color: #1a1a1a !important;
        color: white !important;
    }
    .table-striped tbody tr:hover td {
        background-color: #333 !important;
    }
    .table td a {
        color: #fff !important;
    }
    .form-control,
    .form-select {
        background-color: #1e1e1e;
        color: #fff;
        border-color: #444;
    }
    .form-control::placeholder {
        color: #aaa;
    }
</style>

<div class="container mt-4">
    <h2>Flujo de Caja Mensual</h2>
    <div class="mb-3">
        <button class="btn btn-outline-light me-2" onclick="filtrar('todos')">Todos</button>
        <button class="btn btn-outline-success me-2" onclick="filtrar('ingresos')">Ingresos</button>
        <button class="btn btn-outline-danger me-2" onclick="filtrar('gastos')">Gastos</button>
        <button class="btn btn-outline-warning me-2" onclick="filtrar('propiedades')">Propiedades</button>
        <button class="btn btn-outline-info me-2" onclick="filtrar('prestamos')">Préstamos</button>
    </div>

    <!-- Tarjetas resumen -->
    <div class="row text-center mb-4">
        <div class="col-md-3 mb-2">
            <div class="card shadow-sm border-0" style="background-color: #e8f5e9;">
                <div class="card-body">
                    <i class="fas fa-arrow-down fa-2x text-success mb-2"></i>
                    <h6 class="card-title fw-bold text-success">Ingresos</h6>
                    <p class="card-text fs-5">{{ total_ingresos }} €</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card shadow-sm border-0" style="background-color: #ffebee;">
                <div class="card-body">
                    <i class="fas fa-arrow-up fa-2x text-danger mb-2"></i>
                    <h6 class="card-title fw-bold text-danger">Gastos</h6>
                    <p class="card-text fs-5">{{ total_gastos }} €</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card shadow-sm border-0" style="background-color: #fff8e1;">
                <div class="card-body">
                    <i class="fas fa-home fa-2x text-warning mb-2"></i>
                    <h6 class="card-title fw-bold text-warning">Gastos Alquiler</h6>
                    <p class="card-text fs-5">{{ total_gastos_alquiler }} €</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card shadow-sm border-0" style="background-color: #e3f2fd;">
                <div class="card-body">
                    <i class="fas fa-wallet fa-2x text-primary mb-2"></i>
                    <h6 class="card-title fw-bold text-primary">Balance Total</h6>
                    <p class="card-text fs-5">{{ balance_total }} €</p>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-2">
            <div class="card shadow-sm border-0" style="background-color: #e0f7fa;">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                    <h6 class="card-title fw-bold text-info">Beneficio Neto Propiedades</h6>
                    <p class="card-text fs-5">{{ beneficio_total_propiedades }} €</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-2">
            <div class="card shadow-sm border-0" style="background-color: #f3e5f5;">
                <div class="card-body">
                    <i class="fas fa-university fa-2x text-purple mb-2"></i>
                    <h6 class="card-title fw-bold text-purple">Balance Pendiente Préstamos</h6>
                    <p class="card-text fs-5">{{ balance_pendiente_prestamos }} €</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico -->
    <div class="mt-5 mb-5">
        <canvas id="graficoCashflow"></canvas>
    </div>

    <!-- Tabla Ingresos / Gastos -->
    <div id="ingresos" class="seccion">
        <h4>Ingresos / Gastos</h4>
        <button class="btn btn-success mb-2" data-bs-toggle="modal" data-bs-target="#modalIngreso">+ Añadir Ingreso</button>
        <button class="btn btn-danger mb-2 ms-2" data-bs-toggle="modal" data-bs-target="#modalGasto">+ Añadir Gasto</button>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Categoría</th>
                    <th>Monto</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for r in registros %}
                <tr>
                    <td>{{ r.date }}</td>
                    <td>{{ r.category|title }}</td>
                    <td>{{ r.tipo_ingreso|default_if_none:"-" }}</td>
                    <td>{{ r.amount }} €</td>
                    <td>{{ r.description }}</td>
                    <td><a href="{% url 'editar_registro' r.id %}" class="btn btn-sm btn-primary">Editar</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tabla Propiedades -->
    <div id="propiedades" class="seccion mt-5">
        <div class="d-flex justify-content-between align-items-center">
            <h4>Propiedades en Alquiler</h4>
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalPropiedad">+ Añadir Propiedad</button>
        </div>
        <table class="table table-striped mt-2">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Ingreso</th>
                    <th>Hipoteca</th>
                    <th>Meses Restantes</th>
                    <th>Mantenimiento</th>
                    <th>Beneficio Neto</th>
                </tr>
            </thead>
            <tbody>
                {% for p in propiedades %}
                <tr>
                    <td>{{ p.nombre }}</td>
                    <td>{{ p.ingreso_mensual }} €</td>
                    <td>{{ p.hipoteca_mensual }} €</td>
                    <td>{{ p.meses_restantes_hipoteca }}</td>
                    <td>{{ p.gastos_mantenimiento }} €</td>
                    <td>{{ p.beneficio_neto }} €</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tabla Préstamos -->
    <div id="prestamos" class="seccion mt-5">
        <div class="d-flex justify-content-between align-items-center">
            <h4>Préstamos Personales</h4>
            <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalPrestamo">+ Añadir Préstamo</button>
        </div>
        <table class="table table-striped mt-2">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Cuota Mensual</th>
                    <th>Meses Restantes</th>
                    <th>Balance Pendiente</th>
                </tr>
            </thead>
            <tbody>
                {% for p in prestamos %}
                <tr>
                    <td>{{ p.nombre }}</td>
                    <td>{{ p.cuota_mensual }} €</td>
                    <td>{{ p.meses_restantes }}</td>
                    <td>{{ p.balance_actual }} €</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modales -->
{% include 'alpha_quantum/cashflow/modales_ingreso_gasto.html' %}
{% include 'alpha_quantum/cashflow/modal_propiedad.html' %}
{% include 'alpha_quantum/cashflow/modal_prestamo.html' %}

<!-- ✅ Cargar Chart.js primero -->
<!-- ✅ Cargar Chart.js primero -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ✅ Crear gráfico después de cargar la librería -->
<script>
    const ctx = document.getElementById('graficoCashflow').getContext('2d');

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ labels_grafico|safe }},
            datasets: [
                {
                    label: 'Ingresos',
                    data: {{ valores_ingresos|safe }},
                    borderColor: 'rgba(76, 175, 80, 1)',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(76, 175, 80, 1)',
                },
                {
                    label: 'Gastos',
                    data: {{ valores_gastos|safe }},
                    borderColor: 'rgba(244, 67, 54, 1)',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(244, 67, 54, 1)',
                },
                {
                    label: 'Balance',
                    data: {{ valores_balance|safe }},
                    borderColor: 'rgba(33, 150, 243, 1)',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(33, 150, 243, 1)',
                },
                {
                    label: 'Hipoteca Restante',
                    data: {{ valores_hipoteca_restante|safe }},
                    borderColor: 'rgba(156, 39, 176, 1)',  // Púrpura
                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(156, 39, 176, 1)',
                },
                {
                    label: 'Balance de Cuentas',
                    data: {{ valores_balance_cuentas|safe }},
                    borderColor: 'rgba(255, 193, 7, 1)',  // Amarillo
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(255, 193, 7, 1)',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#fff',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: '#222',
                    titleColor: '#fff',
                    bodyColor: '#fff'
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            scales: {
                x: {
                    ticks: { color: '#fff' },
                    grid: { color: '#444' }
                },
                y: {
                    beginAtZero: true,
                    ticks: { color: '#fff' },
                    grid: { color: '#444' }
                }
            }
        }
    });
</script>


<!-- Bootstrap al final -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
