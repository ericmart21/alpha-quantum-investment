{% extends "alpha_quantum/layout.html" %}
{% load static %}

{% block title %}Flujo de Caja • Alpha Quantum{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
  :root{
    --bg:#0f1317;--panel:#151a21;--panel2:#10161d;--border:#232a33;--text:#e7eef7;
    --muted:#9fb1c1;--ok:#19e3b1;--info:#4ea8ff;--warn:#ff9f43;--down:#ff5964
  }
  body{background:var(--bg);color:var(--text)}
  .card{background:var(--panel)!important;border:1px solid var(--border)!important;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.25)}
  .card-header{background:var(--panel2)!important;border-bottom:1px solid var(--border)!important;border-top-left-radius:16px;border-top-right-radius:16px}
  .page-title{font-weight:800;letter-spacing:.3px}
  .kpi{display:flex;gap:14px;align-items:center;padding:18px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)),var(--panel);border:1px solid var(--border)}
  .kpi .ico{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
  .kpi .meta{color:var(--muted);font-size:.9rem}
  .kpi .val{font-weight:800;font-size:1.6rem}
  .kpi.ok .ico{background:rgba(25,227,177,.12);color:var(--ok);border:1px solid rgba(25,227,177,.35)}
  .kpi.info .ico{background:rgba(78,168,255,.12);color:var(--info);border:1px solid rgba(78,168,255,.35)}
  .kpi.warn .ico{background:rgba(255,159,67,.12);color:var(--warn);border:1px solid rgba(255,159,67,.35)}
  .kpi.down .ico{background:rgba(255,89,100,.12);color:var(--down);border:1px solid rgba(255,89,100,.35)}
  .chip{padding:.35rem .8rem;border-radius:999px;border:1px solid var(--border);background:var(--panel2);color:var(--muted);cursor:pointer}
  .chip.active{background:#102822;border-color:#1f7a66;color:#9af0d8}
  .badge-soft{border:1px solid var(--border);background:#0f161a;color:#cfe7df;padding:.25rem .55rem;border-radius:10px;font-size:.75rem}
  .badge-up{color:var(--ok);border-color:rgba(25,227,177,.35)}
  .badge-down{color:var(--down);border-color:rgba(255,89,100,.35)}
  .table thead th{color:var(--muted);border-color:var(--border)}
  .table tbody td{border-color:#1f2937}
  .table tfoot td{border-top:1px solid var(--border)!important;color:#cfe7df}
  .btn-outline-light{--bs-btn-color:#e7eef7;--bs-btn-border-color:#6b7280}
  .modal-content{background:#0f161a;border:1px solid var(--border);color:#e7eef7}
  .form-control, .form-select{background:#121820;border-color:#2a3441;color:#e7eef7}
  .form-control:focus, .form-select:focus{background:#121820;color:#e7eef7;border-color:#375a7f;box-shadow:none}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="page-title">Flujo de Caja Mensual</h2>
    <div class="d-flex gap-2">
      <button id="btnExport" class="btn btn-sm btn-outline-light"><i class="bi bi-filetype-csv me-1"></i>Exportar CSV</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-xl-2 col-md-4">
      <div class="kpi ok">
        <div class="ico"><i class="bi bi-piggy-bank-fill fs-5"></i></div>
        <div><div class="meta">Ingresos</div><div class="val" id="kpiIngresos">0 €</div><div class="meta">Último período</div></div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4">
      <div class="kpi info">
        <div class="ico"><i class="bi bi-house-check fs-5"></i></div>
        <div><div class="meta">Beneficio Propiedades</div><div class="val" id="kpiPropiedades">0 €</div><div class="meta">Neto mensual</div></div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4">
      <div class="kpi warn">
        <div class="ico"><i class="bi bi-credit-card-2-front fs-5"></i></div>
        <div><div class="meta">Gastos</div><div class="val" id="kpiGastos">0 €</div><div class="meta">Último período</div></div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4">
      <div class="kpi down">
        <div class="ico"><i class="bi bi-bank fs-5"></i></div>
        <div><div class="meta">Deuda mensual</div><div class="val" id="kpiDeuda">0 €</div><div class="meta">Hipotecas + préstamos</div></div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4">
      <div class="kpi ok">
        <div class="ico"><i class="bi bi-cash-coin fs-5"></i></div>
        <div><div class="meta">Balance total</div><div class="val" id="kpiBalance">0 €</div><div class="meta">Acumulado</div></div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4">
      <div class="kpi info">
        <div class="ico"><i class="bi bi-graph-up-arrow fs-5"></i></div>
        <div><div class="meta">Tasa de ahorro</div><div class="val" id="kpiAhorro">0 %</div><div class="meta">Ingresos – (gastos+deuda)</div></div>
      </div>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Flujo de Caja</span>
      <div class="d-flex gap-2 align-items-center">
        <span class="chip active" data-range="3M">3M</span>
        <span class="chip" data-range="6M">6M</span>
        <span class="chip" data-range="1A">1A</span>
        <span class="chip" data-range="5A">5A</span>
        <span class="chip" data-range="TODO">TODO</span>
        <button id="btnResetZoom" class="btn btn-sm btn-outline-light">Reset zoom</button>
      </div>
    </div>
    <div class="card-body" style="height:380px">
      <canvas id="cashflowChart"></canvas>
    </div>
  </div>

  <div class="row g-3">
    <!-- Ingresos/Gastos -->
    <div class="col-xl-7">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Ingresos / Gastos</span>
          <div class="d-flex gap-2">
            <span class="chip active" data-filter="all">Todos</span>
            <span class="chip" data-filter="ingreso">Ingresos</span>
            <span class="chip" data-filter="gasto">Gastos</span>
            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalNuevoIngreso">+ Añadir ingreso</button>
            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalNuevoGasto">+ Añadir gasto</button>
          </div>
        </div>
        <div class="table-responsive p-2">
          <table class="table table-dark table-hover align-middle mb-0" id="tablaMovs">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Categoría</th>
                <th>Descripción</th>
                <th class="text-end">Monto</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for r in registros %}
              <tr data-tipo="{{ r.category }}">
                <td>{{ r.date|date:"Y-m-d" }}</td>
                <td>
                  {% if r.category == 'ingreso' %}
                    <span class="badge-soft badge-up">Ingreso</span>
                  {% else %}
                    <span class="badge-soft badge-down">Gasto</span>
                  {% endif %}
                </td>
                <td>{{ r.subcategory|default:"-" }}</td>
                <td>{{ r.description|default:"-" }}</td>
                <td class="text-end">{{ r.amount|floatformat:2 }} €</td>
                <td class="text-end">
                  <!-- EDITAR REGISTRO EN MODAL -->
                  <button
                    class="btn btn-sm btn-outline-light"
                    data-bs-toggle="modal"
                    data-bs-target="#modalEditarRegistro"
                    data-id="{{ r.id }}"
                    data-fecha="{{ r.date|date:'Y-m-d' }}"
                    data-categoria="{{ r.category }}"
                    data-subcategoria="{{ r.subcategory }}"
                    data-descripcion="{{ r.description }}"
                    data-monto="{{ r.amount }}">
                    Editar
                  </button>
                  <form action="{% url 'eliminar_registro' r.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar?')">Borrar</button>
                  </form>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="text-center text-muted">Sin movimientos.</td></tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr><td colspan="4" class="text-end">Total ingresos:</td><td class="text-end" id="footIngresos">0 €</td><td></td></tr>
              <tr><td colspan="4" class="text-end">Total gastos:</td><td class="text-end" id="footGastos">0 €</td><td></td></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Propiedades y Préstamos -->
    <div class="col-xl-5">
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Propiedades en Alquiler</span>
          <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalNuevaPropiedad">+ Añadir Propiedad</button>
        </div>
        <div class="table-responsive p-2">
          <table class="table table-dark table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Nombre</th>
                <th class="text-end">Ingreso</th>
                <th class="text-end">Hipoteca</th>
                <th class="text-end">Mantenimiento</th>
                <th class="text-end">Meses Rest.</th>
                <th class="text-end">Beneficio Neto</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for p in propiedades %}
              <tr>
                <td>{{ p.nombre }}</td>
                <td class="text-end">{{ p.ingreso_mensual|floatformat:2 }} €</td>
                <td class="text-end">{{ p.hipoteca_mensual|floatformat:2 }} €</td>
                <td class="text-end">{{ p.gastos_mantenimiento|floatformat:2 }} €</td>
                <td class="text-end">{{ p.meses_restantes_hipoteca }}</td>
                <td class="text-end">
                  {% with p.beneficio_neto as bn %}
                    <span class="badge-soft {% if bn >= 0 %}badge-up{% else %}badge-down{% endif %}">{{ bn|floatformat:2 }} €</span>
                  {% endwith %}
                </td>
                <td class="text-end">
                  <!-- EDITAR PROPIEDAD EN MODAL -->
                  <button
                    class="btn btn-sm btn-outline-light"
                    data-bs-toggle="modal"
                    data-bs-target="#modalEditarPropiedad"
                    data-id="{{ p.id }}"
                    data-nombre="{{ p.nombre }}"
                    data-ingreso="{{ p.ingreso_mensual }}"
                    data-hipoteca="{{ p.hipoteca_mensual }}"
                    data-mant="{{ p.gastos_mantenimiento }}"
                    data-meses="{{ p.meses_restantes_hipoteca }}"
                    data-fecha="{{ p.fecha_inicio_hipoteca|date:'Y-m-d' }}">
                    Editar
                  </button>
                  <form action="{% url 'eliminar_propiedad' p.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar?')">Borrar</button>
                  </form>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="text-center text-muted">Sin propiedades.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Préstamos Personales</span>
          <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalNuevoPrestamo">+ Añadir Préstamo</button>
        </div>
        <div class="table-responsive p-2">
          <table class="table table-dark table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Nombre</th>
                <th class="text-end">Cuota</th>
                <th class="text-end">Meses Rest.</th>
                <th class="text-end">Balance</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pr in prestamos %}
              <tr>
                <td>{{ pr.nombre }}</td>
                <td class="text-end">{{ pr.cuota_mensual|floatformat:2 }} €</td>
                <td class="text-end">{{ pr.meses_restantes }}</td>
                <td class="text-end">{{ pr.balance_actual|floatformat:2 }} €</td>
                <td class="text-end">
                  <!-- EDITAR PRÉSTAMO EN MODAL -->
                  <button
                    class="btn btn-sm btn-outline-light"
                    data-bs-toggle="modal"
                    data-bs-target="#modalEditarPrestamo"
                    data-id="{{ pr.id }}"
                    data-nombre="{{ pr.nombre }}"
                    data-cuota="{{ pr.cuota_mensual }}"
                    data-meses="{{ pr.meses_restantes }}"
                    data-balance="{{ pr.balance_actual }}"
                    data-fecha="{{ pr.fecha_inicio|date:'Y-m-d' }}">
                    Editar
                  </button>
                  <form action="{% url 'eliminar_prestamo' pr.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar?')">Borrar</button>
                  </form>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted">Sin préstamos.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- =============== MODALES =============== -->

  <!-- Añadir Ingreso -->
  <div class="modal fade" id="modalNuevoIngreso" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{% url 'agregar_ingreso' %}">
          {% csrf_token %}
          <div class="modal-header"><h5 class="modal-title">Añadir ingreso</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" name="category" value="ingreso">
            <div class="mb-2"><label>Fecha</label><input type="date" name="date" class="form-control" required></div>
            <div class="mb-2"><label>Categoría</label><input type="text" name="subcategory" class="form-control" placeholder="Salario, etc."></div>
            <div class="mb-2"><label>Descripción</label><input type="text" name="description" class="form-control"></div>
            <div class="mb-2"><label>Monto (€)</label><input type="number" step="0.01" name="amount" class="form-control" required></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Añadir Gasto -->
  <div class="modal fade" id="modalNuevoGasto" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{% url 'agregar_gasto' %}">
          {% csrf_token %}
          <div class="modal-header"><h5 class="modal-title">Añadir gasto</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" name="category" value="gasto">
            <div class="mb-2"><label>Fecha</label><input type="date" name="date" class="form-control" required></div>
            <div class="mb-2"><label>Categoría</label><input type="text" name="subcategory" class="form-control" placeholder="Luz, etc."></div>
            <div class="mb-2"><label>Descripción</label><input type="text" name="description" class="form-control"></div>
            <div class="mb-2"><label>Monto (€)</label><input type="number" step="0.01" name="amount" class="form-control" required></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Editar Registro (Ingreso/Gasto) -->
  <div class="modal fade" id="modalEditarRegistro" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" id="formEditarRegistro">
          {% csrf_token %}
          <div class="modal-header"><h5 class="modal-title">Editar registro</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-2"><label>Fecha</label><input type="date" name="date" id="edit-date" class="form-control" required></div>
            <div class="mb-2">
              <label>Tipo</label>
              <select name="category" id="edit-category" class="form-select">
                <option value="ingreso">Ingreso</option>
                <option value="gasto">Gasto</option>
              </select>
            </div>
            <div class="mb-2"><label>Categoría</label><input type="text" name="subcategory" id="edit-subcategory" class="form-control"></div>
            <div class="mb-2"><label>Descripción</label><input type="text" name="description" id="edit-description" class="form-control"></div>
            <div class="mb-2"><label>Monto (€)</label><input type="number" step="0.01" name="amount" id="edit-amount" class="form-control" required></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Añadir Propiedad -->
  <div class="modal fade" id="modalNuevaPropiedad" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{% url 'agregar_propiedad' %}">
          {% csrf_token %}
          <div class="modal-header"><h5 class="modal-title">Añadir propiedad</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-2"><label>Nombre</label><input type="text" name="nombre" class="form-control" required></div>
            <div class="mb-2"><label>Ingreso mensual</label><input type="number" step="0.01" name="ingreso_mensual" class="form-control" required></div>
            <div class="mb-2"><label>Hipoteca mensual</label><input type="number" step="0.01" name="hipoteca_mensual" class="form-control" required></div>
            <div class="mb-2"><label>Gastos mantenimiento</label><input type="number" step="0.01" name="gastos_mantenimiento" class="form-control" required></div>
            <div class="mb-2"><label>Meses restantes hipoteca</label><input type="number" name="meses_restantes_hipoteca" class="form-control" required></div>
            <div class="mb-2"><label>Inicio hipoteca (opcional)</label><input type="date" name="fecha_inicio_hipoteca" class="form-control"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Editar Propiedad -->
  <div class="modal fade" id="modalEditarPropiedad" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" id="formEditarPropiedad">
          {% csrf_token %}
          <div class="modal-header"><h5 class="modal-title">Editar propiedad</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-2"><label>Nombre</label><input type="text" name="nombre" id="prop-nombre" class="form-control" required></div>
            <div class="mb-2"><label>Ingreso mensual</label><input type="number" step="0.01" name="ingreso_mensual" id="prop-ingreso" class="form-control" required></div>
            <div class="mb-2"><label>Hipoteca mensual</label><input type="number" step="0.01" name="hipoteca_mensual" id="prop-hipoteca" class="form-control" required></div>
            <div class="mb-2"><label>Gastos mantenimiento</label><input type="number" step="0.01" name="gastos_mantenimiento" id="prop-mant" class="form-control" required></div>
            <div class="mb-2"><label>Meses restantes hipoteca</label><input type="number" name="meses_restantes_hipoteca" id="prop-meses" class="form-control" required></div>
            <div class="mb-2"><label>Inicio hipoteca</label><input type="date" name="fecha_inicio_hipoteca" id="prop-fecha" class="form-control"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Añadir Préstamo -->
  <div class="modal fade" id="modalNuevoPrestamo" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{% url 'agregar_prestamo' %}">
          {% csrf_token %}
          <div class="modal-header"><h5 class="modal-title">Añadir préstamo</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-2"><label>Nombre</label><input type="text" name="nombre" class="form-control" required></div>
            <div class="mb-2"><label>Cuota mensual</label><input type="number" step="0.01" name="cuota_mensual" class="form-control" required></div>
            <div class="mb-2"><label>Meses restantes</label><input type="number" name="meses_restantes" class="form-control" required></div>
            <div class="mb-2"><label>Balance actual</label><input type="number" step="0.01" name="balance_actual" class="form-control"></div>
            <div class="mb-2"><label>Fecha inicio (opcional)</label><input type="date" name="fecha_inicio" class="form-control"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Editar Préstamo -->
  <div class="modal fade" id="modalEditarPrestamo" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" id="formEditarPrestamo">
          {% csrf_token %}
          <div class="modal-header"><h5 class="modal-title">Editar préstamo</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-2"><label>Nombre</label><input type="text" name="nombre" id="loan-nombre" class="form-control" required></div>
            <div class="mb-2"><label>Cuota mensual</label><input type="number" step="0.01" name="cuota_mensual" id="loan-cuota" class="form-control" required></div>
            <div class="mb-2"><label>Meses restantes</label><input type="number" name="meses_restantes" id="loan-meses" class="form-control" required></div>
            <div class="mb-2"><label>Balance actual</label><input type="number" step="0.01" name="balance_actual" id="loan-balance" class="form-control"></div>
            <div class="mb-2"><label>Fecha inicio</label><input type="date" name="fecha_inicio" id="loan-fecha" class="form-control"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ========= Helpers =========
  const fmtEUR = v => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(Number(v||0));
  const fmtPct = v => `${Number(v||0).toFixed(2)} %`;
  function parseEURCell(text){
    return parseFloat(String(text||'0').replace(/\s|€/g,'').replace(/\./g,'').replace(',', '.'))||0;
  }

  // ========= Estado gráfico =========
  let cashflowChart=null;
  function renderChart(payload){
    const {labels, ingresos, gastos, deuda_total, balance_cuentas, deuda_mensual}=payload;
    const ctx=document.getElementById('cashflowChart').getContext('2d');
    if(cashflowChart) cashflowChart.destroy();
    const stackedMax=Math.max(...(ingresos||[0]),...((gastos||[]).map((g,i)=>g+(deuda_mensual?.[i]||0))));
    cashflowChart=new Chart(ctx,{
      data:{
        labels,
        datasets:[
          {type:'bar',label:'Ingresos',data:ingresos,yAxisID:'yIngresos',backgroundColor:'#19e3b1',stack:'cashflowIn'},
          {type:'bar',label:'Gastos',data:gastos,yAxisID:'yIngresos',backgroundColor:'#ff5964',stack:'cashflow'},
          {type:'bar',label:'Deuda mensual',data:deuda_mensual,yAxisID:'yIngresos',backgroundColor:'#feca57',stack:'cashflow'},
          {type:'line',label:'Deuda total',data:deuda_total,yAxisID:'yDeuda',borderColor:'#ff9f43',tension:.3,borderWidth:2,pointRadius:0,fill:false},
          {type:'line',label:'Balance de cuentas',data:balance_cuentas,yAxisID:'yDeuda',borderColor:'#4ea8ff',backgroundColor:'rgba(78,168,255,.12)',tension:.3,borderWidth:2,pointRadius:0,fill:true}
        ]
      },
      options:{
        responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
        plugins:{legend:{labels:{color:'#cfe7df'}},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${fmtEUR(ctx.parsed.y)}`}}},
        scales:{
          yIngresos:{position:'left',ticks:{color:'#cfe7df',callback:v=>fmtEUR(v)},grid:{color:'#1f2730'},suggestedMin:0,suggestedMax:stackedMax*1.2},
          yDeuda:{position:'right',ticks:{color:'#cfe7df',callback:v=>fmtEUR(v)},grid:{drawOnChartArea:false}},
          x:{ticks:{color:'#cfe7df'},grid:{color:'#1f2730'}}
        }
      }
    });
  }

  // ========= KPIs + carga de serie =========
  function setKpiLabels(kpis){
    document.getElementById('kpiIngresos').textContent=fmtEUR(kpis.ingresos);
    document.getElementById('kpiPropiedades').textContent=fmtEUR(kpis.beneficio_propiedades);
    document.getElementById('kpiGastos').textContent=fmtEUR(kpis.gastos);
    document.getElementById('kpiDeuda').textContent=fmtEUR(kpis.deuda_mensual);
    document.getElementById('kpiBalance').textContent=fmtEUR(kpis.balance_total);
    let tasa=typeof kpis.tasa_ahorro==='number'?kpis.tasa_ahorro:(kpis.ingresos>0?((kpis.ingresos-(kpis.gastos+kpis.deuda_mensual))/kpis.ingresos*100):0);
    document.getElementById('kpiAhorro').textContent=fmtPct(tasa);
    try{
      const mesLabel=kpis.mes||'';
      const metaIngresos=document.getElementById('kpiIngresos').parentElement.querySelectorAll('.meta');
      const metaGastos=document.getElementById('kpiGastos').parentElement.querySelectorAll('.meta');
      if(metaIngresos[1]) metaIngresos[1].textContent=`Último período: ${mesLabel}`;
      if(metaGastos[1]) metaGastos[1].textContent=`Último período: ${mesLabel}`;
    }catch(_){}
  }

  async function loadSeries(range='3M'){
    try{
      const res=await fetch(`/api/cashflow/series?range=${encodeURIComponent(range)}`);
      const d=await res.json();
      setKpiLabels(d.kpis||{});
      renderChart(d);
    }catch(e){ console.error('Error cargando series de cashflow:',e); }
  }

  // ========= Filtros de la tabla + totales =========
  function refreshFooters(){
    const rows=[...document.querySelectorAll('#tablaMovs tbody tr')].filter(r=>r.style.display!=='none');
    let totalIngresos=0,totalGastos=0;
    rows.forEach(r=>{
      const valCell=r.querySelector('td.text-end'); const val=parseEURCell(valCell?valCell.textContent:'0');
      if(r.dataset.tipo==='ingreso') totalIngresos+=val; else totalGastos+=val;
    });
    document.getElementById('footIngresos').textContent=fmtEUR(totalIngresos);
    document.getElementById('footGastos').textContent=fmtEUR(totalGastos);
  }

  function bindTableFilters(){
    document.querySelectorAll('[data-filter]').forEach(chip=>{
      chip.addEventListener('click',()=>{
        document.querySelectorAll('[data-filter]').forEach(x=>x.classList.remove('active'));
        chip.classList.add('active');
        const filter=chip.dataset.filter;
        document.querySelectorAll('#tablaMovs tbody tr').forEach(tr=>{
          tr.style.display=(filter==='all'||tr.dataset.tipo===filter)?'':'none';
        });
        refreshFooters();
      });
    });
  }

  // ========= Export =========
  document.getElementById('btnExport').addEventListener('click',()=>{ window.location.href="{% url 'cashflow_export_csv' %}"; });

  // ========= Rango del gráfico =========
  function bindRangeChips(){
    document.querySelectorAll('[data-range]').forEach(chip=>{
      chip.addEventListener('click',()=>{
        document.querySelectorAll('[data-range]').forEach(x=>x.classList.remove('active'));
        chip.classList.add('active'); loadSeries(chip.dataset.range);
      });
    });
    document.getElementById('btnResetZoom').addEventListener('click',()=>{
      const active=document.querySelector('[data-range].active');
      loadSeries(active?active.dataset.range:'3M');
    });
  }

  // ========= Modales EDITAR (relleno + action) =========
  const getUrlEditarRegistro = (id) => `{% url 'editar_registro' 0 %}`.replace('/0/','/'+id+'/');
  const getUrlEditarPropiedad = (id) => `{% url 'editar_propiedad' 0 %}`.replace('/0/','/'+id+'/');
  const getUrlEditarPrestamo = (id) => `{% url 'editar_prestamo' 0 %}`.replace('/0/','/'+id+'/');

  // Registro
  const modalReg=document.getElementById('modalEditarRegistro');
  modalReg.addEventListener('show.bs.modal', ev=>{
    const b=ev.relatedTarget;
    document.getElementById('formEditarRegistro').action=getUrlEditarRegistro(b.dataset.id);
    document.getElementById('edit-date').value=b.dataset.fecha||'';
    document.getElementById('edit-category').value=b.dataset.categoria||'ingreso';
    document.getElementById('edit-subcategory').value=b.dataset.subcategoria||'';
    document.getElementById('edit-description').value=b.dataset.descripcion||'';
    document.getElementById('edit-amount').value=b.dataset.monto||'';
  });

  // Propiedad
  const modalProp=document.getElementById('modalEditarPropiedad');
  modalProp.addEventListener('show.bs.modal', ev=>{
    const b=ev.relatedTarget;
    document.getElementById('formEditarPropiedad').action=getUrlEditarPropiedad(b.dataset.id);
    document.getElementById('prop-nombre').value=b.dataset.nombre||'';
    document.getElementById('prop-ingreso').value=b.dataset.ingreso||'';
    document.getElementById('prop-hipoteca').value=b.dataset.hipoteca||'';
    document.getElementById('prop-mant').value=b.dataset.mant||'';
    document.getElementById('prop-meses').value=b.dataset.meses||'';
    document.getElementById('prop-fecha').value=b.dataset.fecha||'';
  });

  // Préstamo
  const modalLoan=document.getElementById('modalEditarPrestamo');
  modalLoan.addEventListener('show.bs.modal', ev=>{
    const b=ev.relatedTarget;
    document.getElementById('formEditarPrestamo').action=getUrlEditarPrestamo(b.dataset.id);
    document.getElementById('loan-nombre').value=b.dataset.nombre||'';
    document.getElementById('loan-cuota').value=b.dataset.cuota||'';
    document.getElementById('loan-meses').value=b.dataset.meses||'';
    document.getElementById('loan-balance').value=b.dataset.balance||'';
    document.getElementById('loan-fecha').value=b.dataset.fecha||'';
  });

  // ========= Init =========
  document.addEventListener('DOMContentLoaded',()=>{
    bindTableFilters(); refreshFooters();
    bindRangeChips(); loadSeries('3M');
  });
</script>
{% endblock %}
